//
//  UserProfileShowInteractor.swift
//  golos-ios
//
//  Created by msm72 on 29.06.2018.
//  Copyright (c) 2018 golos. All rights reserved.
//
//  This file was generated by the Clean Swift Xcode Templates so
//  you can apply clean architecture to your iOS and Mac projects,
//  see http://clean-swift.com
//

import UIKit
import CoreData
import GoloSwift

// MARK: - Business Logic protocols
protocol UserProfileShowBusinessLogic {
    func save(_ lastLentaPost: Post?)
    func loadUserInfo(withRequestModel requestModel: UserProfileShowModels.UserInfo.RequestModel)
    func loadUserDetailsLenta(withRequestModel requestModel: UserProfileShowModels.UserDetails.RequestModel)
}

protocol UserProfileShowDataStore {
    var lastLentaPost: Post? { get set }
}

class UserProfileShowInteractor: UserProfileShowBusinessLogic, UserProfileShowDataStore {
    // MARK: - Properties
    var presenter: UserProfileShowPresentationLogic?
    
    
    // MARK: - UserProfileShowDataStore implementation
    var lastLentaPost: Post?
    
    
    // MARK: - Class Initialization
    deinit {
        Logger.log(message: "Success", event: .severe)
    }
    

    // MARK: - Business logic implementation
    func save(_ lastLentaPost: Post?) {
        self.lastLentaPost = lastLentaPost
    }
    
    func loadUserInfo(withRequestModel requestModel: UserProfileShowModels.UserInfo.RequestModel) {
        // API 'get_accounts'
        if isNetworkAvailable {
            // Create MethodAPIType
            let names           =   User.current!.name
            let methodAPIType   =   MethodAPIType.getAccounts(names: RequestParameterAPI.User(names: [names]))
            
            broadcast.executeGET(byMethodAPIType: methodAPIType,
                                 onResult: { [weak self] responseAPIResult in
                                    Logger.log(message: "\nresponse API Result = \(responseAPIResult)\n", event: .debug)
                                    
                                    guard let userResult = (responseAPIResult as! ResponseAPIUserResult).result, userResult.count > 0 else {
                                        // Send empty User info
                                        let userInfoResponseModel = UserProfileShowModels.UserInfo.ResponseModel(error: nil)
                                        self?.presenter?.presentUserInfo(fromResponseModel: userInfoResponseModel)
                                        
                                        return
                                    }
                                    
                                    // CoreData: Update User entity
                                    if let userResponseAPI = userResult.first {
                                        let userEntity              =   User.instance(byUserID: userResponseAPI.id)
                                        userEntity.isAuthorized     =   true
                                        userEntity.updateEntity(fromResponseAPI: userResponseAPI)
                                    }
                                    
                                    // Send User info
                                    let userInfoResponseModel = UserProfileShowModels.UserInfo.ResponseModel(error: nil)
                                    self?.presenter?.presentUserInfo(fromResponseModel: userInfoResponseModel)
                },
                                 onError: { [weak self] errorAPI in
                                    Logger.log(message: "nresponse API Error = \(errorAPI.caseInfo.message)\n", event: .error)
                                    
                                    // Send error
                                    let userInfoResponseModel = UserProfileShowModels.UserInfo.ResponseModel(error: errorAPI)
                                    self?.presenter?.presentUserInfo(fromResponseModel: userInfoResponseModel)
            })
        }
        
        // Offline mode
        else {
            // Send User info
            let userInfoResponseModel = UserProfileShowModels.UserInfo.ResponseModel(error: nil)
            self.presenter?.presentUserInfo(fromResponseModel: userInfoResponseModel)
        }
    }
    
    func loadUserDetailsLenta(withRequestModel requestModel: UserProfileShowModels.UserDetails.RequestModel) {
        // API 'get_discussions_by_blog'
        if isNetworkAvailable {
            // Create MethodAPIType
            let discussion      =   (lastLentaPost == nil) ?   RequestParameterAPI.Discussion.init(limit:          loadDataLimit,
                                                                                                   truncateBody:   0,
                                                                                                   selectAuthors:  [ User.current!.name ]) :
                                                                RequestParameterAPI.Discussion.init(limit:          loadDataLimit,
                                                                                                    truncateBody:   0,
                                                                                                    selectAuthors:  [ User.current!.name ],
                                                                                                    startAuthor:    lastLentaPost!.author,
                                                                                                    startPermlink:  lastLentaPost!.permlink)

            let methodAPIType   =   MethodAPIType.getDiscussions(type: .lenta, parameters: discussion)
            
            // API 'get_discussions_by_blog'
            broadcast.executeGET(byMethodAPIType: methodAPIType,
                                 onResult: { [weak self] responseAPIResult in
                                    Logger.log(message: "\nresponse API Result = \(responseAPIResult)\n", event: .debug)
                                    
                                    guard let result = (responseAPIResult as! ResponseAPIFeedResult).result, result.count > 0 else {
                                        // Send User details blogs
                                        let userDetailsBlogsResponseModel = UserProfileShowModels.UserDetails.ResponseModel(error: nil)
                                        self?.presenter?.presentUserDetailsLenta(fromResponseModel: userDetailsBlogsResponseModel)

                                        return
                                    }
                                    
                                    // CoreData: Update Post (lenta) entity
                                    _ = result.map({ responseAPIFeed in
                                        Post.updateEntity(fromResponseAPI: responseAPIFeed, andPostsFeedType: .lenta)
                                    })
                                    
                                    // Send User details lenta (blogs)
                                    let userDetailsBlogsResponseModel = UserProfileShowModels.UserDetails.ResponseModel(error: nil)
                                    self?.presenter?.presentUserDetailsLenta(fromResponseModel: userDetailsBlogsResponseModel)
                },
                                 onError: { [weak self] errorAPI in
                                    Logger.log(message: "nresponse API Error = \(errorAPI.caseInfo.message)\n", event: .error)

                                    // Send error
                                    let userDetailsBlogsResponseModel = UserProfileShowModels.UserDetails.ResponseModel(error: errorAPI)
                                    self?.presenter?.presentUserDetailsLenta(fromResponseModel: userDetailsBlogsResponseModel)
            })
        }
        
        // Offline mode
        else {
            // Send User details lenta (blogs)
            let userDetailsBlogsResponseModel = UserProfileShowModels.UserDetails.ResponseModel(error: nil)
            self.presenter?.presentUserDetailsLenta(fromResponseModel: userDetailsBlogsResponseModel)
        }
    }
}
